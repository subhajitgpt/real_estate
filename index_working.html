<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Property Estimator & Retail Feasibility</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --ink:#0f172a; --muted:#677084; --soft:#e7eef5; --brand:#1e40af; --brand2:#3b82f6; --card:#ffffff; }
    body{background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);color:var(--ink)}
    .navbar{background:linear-gradient(90deg,#1e40af,#3b82f6)}
    .navbar .navbar-brand,.navbar .navbar-text{color:#fff}
    .card-soft{border:1px solid #dbeafe;box-shadow:0 4px 14px rgba(30,64,175,.08);background:var(--card);border-radius:18px}
    .mapbox{width:100%;height:440px;border:1px solid #e7eef5;border-radius:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .prewrap{white-space:pre-wrap}
    .badge-soft{background:#eff6ff;color:#1e40af;border-radius:999px}
    .nav-tabs{border-bottom:2px solid #1e40af}
    .stat{border:1px solid #e7eef5;border-radius:16px;padding:14px 16px;background:#fff}
    .stat .label{color:#677084;font-size:.9rem}
    .stat .value{font-weight:700;font-size:1.15rem}
    .btn-pill{border-radius:999px}
    .form-help{font-size:.85rem;color:#677084}
    .finder-cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
    @media (max-width: 992px){ .finder-cards{grid-template-columns:1fr} }
    .prop-card{border:1px solid #e7eef5;border-radius:16px;background:#fff;padding:14px;transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;}
    .prop-card:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(20,30,60,.08)}
    .prop-title{font-weight:800}
    .pill{border-radius:999px;padding:.2rem .55rem;background:#f1f5ff;border:1px solid #e7eef5;font-size:.8rem}
    .rating{display:inline-flex;align-items:center;gap:6px}
    .rating .star{color:#f59e0b}
    .next-steps-notice{
      background:linear-gradient(135deg,#1e40af,#3b82f6);
      color:white;
      padding:16px;
      margin-top:20px;
      border-radius:12px;
      text-align:center;
      font-weight:bold;
      box-shadow:0 4px 12px rgba(30,64,175,0.3);
      border:2px solid #1d4ed8;
    }
    .next-steps-notice:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(30,64,175,0.4);
    }
    
    /* Priority Dropdown Color Coding */
    .priority-high {
      background-color: #fef2f2 !important;
      color: #dc2626 !important;
      border-color: #fca5a5 !important;
      font-weight: 600;
    }
    .priority-medium {
      background-color: #fffbeb !important;
      color: #d97706 !important;
      border-color: #fcd34d !important;
      font-weight: 600;
    }
    .priority-low {
      background-color: #f0fdf4 !important;
      color: #16a34a !important;
      border-color: #bbf7d0 !important;
      font-weight: 600;
    }
    
    /* Chat Interface Styles */
    .chat-message {
      margin-bottom: 1rem;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .chat-message.user {
      flex-direction: row-reverse;
    }
    .chat-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    .chat-avatar.user {
      background: #0d6efd;
      color: white;
    }
    .chat-avatar.assistant {
      background: #198754;
      color: white;
    }
    .chat-bubble {
      max-width: 75%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      position: relative;
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.4;
    }
    .chat-bubble.user {
      background: #0d6efd;
      color: white;
      border-bottom-right-radius: 0.25rem;
    }
    .chat-bubble.assistant {
      background: white;
      color: #333;
      border: 1px solid #dee2e6;
      border-bottom-left-radius: 0.25rem;
    }
    .chat-bubble.assistant.typing {
      background: #f8f9fa;
      font-style: italic;
      color: #6c757d;
    }
    #chatContainer {
      scroll-behavior: smooth;
    }
    #chatContainer::-webkit-scrollbar {
      width: 6px;
    }
    #chatContainer::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    #chatContainer::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    #chatContainer::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Priority Dropdown Styles */
    .priority-select {
      min-width: 140px;
      width: 140px;
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: white;
      transition: all 0.2s ease;
      font-weight: 500;
      position: relative;
    }
    
    .priority-select:focus,
    .priority-select:active {
      z-index: 999;
    }
    
    .priority-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
    
    .priority-select option {
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .priority-section {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      position: relative;
      z-index: 1;
      margin-left: 10px;
      min-height: 50px;
    }
    
    .priority-label {
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 2px;
    }
    
    /* 99acres Theme Enhancements */
    .btn-primary {
      background: linear-gradient(135deg, #1e40af, #3b82f6);
      border: none;
      color: white;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(30, 64, 175, 0.2);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #1d4ed8, #2563eb);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
    }
    
    .btn-outline-secondary {
      border-color: #1e40af;
      color: #1e40af;
    }
    
    .btn-outline-secondary:hover {
      background-color: #1e40af;
      border-color: #1e40af;
    }
    
    .form-control:focus {
      border-color: #1e40af;
      box-shadow: 0 0 0 0.2rem rgba(30, 64, 175, 0.25);
    }
    
    .form-select:focus {
      border-color: #1e40af;
      box-shadow: 0 0 0 0.2rem rgba(30, 64, 175, 0.25);
    }
    
    /* POI Control Row Styles */
    .poi-control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: linear-gradient(135deg, #ffffff, #f8fafc);
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      position: relative;
    }
    
    .poi-control-row:hover {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-color: #cbd5e1;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }
    
    .poi-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
      border: 2px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      margin-right: 10px;
    }
    
    .poi-left-section {
      display: flex;
      align-items: center;
      flex: 1;
      min-width: 0;
    }
    
    .poi-switch {
      display: flex;
      align-items: center;
    }
    
    .poi-switch .form-check-input {
      margin-right: 8px;
      transform: scale(1.1);
    }
    
    .poi-switch .form-check-label {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin: 0;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg mb-3">
    <div class="container-fluid">
      <span class="navbar-text">üè° Smart Property Analysis ‚Ä¢ Location Intelligence</span>
      <div class="ms-auto d-flex gap-2 align-items-center">
        <button id="btnOpenAIModal" class="btn btn-light btn-sm">‚ú® Ask Atlas</button>
      </div>
    </div>
  </nav>

  <div class="container">
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-finder" data-bs-toggle="tab" data-bs-target="#panel-finder" type="button" role="tab">1) Property Finder (AI)</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-retail" data-bs-toggle="tab" data-bs-target="#panel-retail" type="button" role="tab">2) Retail Location Feasibility</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-prop" data-bs-toggle="tab" data-bs-target="#panel-prop" type="button" role="tab">3) Property Value &amp; Rent Estimator</button>
      </li>
    </ul>

    <div class="tab-content py-3">
      <!-- ===== Property Finder (AI) ===== -->
      <div class="tab-pane fade show active" id="panel-finder" role="tabpanel">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card card-soft p-3">
              <h6 class="mb-2">Find Housing Projects (Exact Map Names)</h6>
              <div class="form-help mb-2">
                Set preferences and we‚Äôll return <b>project/society names</b> matching Google Maps so you can paste them into the search in Tab 2.
              </div>
              <div class="row g-2">
                <div class="col-12">
                  <label class="form-label">Country</label>
                  <select id="pfCountry" class="form-select">
                    <option value="India" selected>India</option>
                    <option value="UAE">UAE</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">Property Type</label>
                  <div class="row g-2">
                    <div class="col-6">
                      <input type="radio" id="propTypeResidential" name="propertyType" value="residential" class="property-type-radio" checked>
                      <label for="propTypeResidential" class="property-type-label">
                        üè† Residential
                      </label>
                    </div>
                    <div class="col-6">
                      <input type="radio" id="propTypeCommercial" name="propertyType" value="commercial" class="property-type-radio">
                      <label for="propTypeCommercial" class="property-type-label">
                        üè¢ Commercial
                      </label>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label">City</label>
                  <input id="pfCity" class="form-control" placeholder="e.g., Kolkata, Dubai">
                </div>
                <div class="col-6">
                  <label class="form-label" id="pfTypeLabel">Apt Type</label>
                  <select id="pfType" class="form-select">
                    <option value="1 BHK">1 BHK</option>
                    <option value="2 BHK" selected>2 BHK</option>
                    <option value="3 BHK">3 BHK</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">Locality</label>
                  <input id="pfLocality" class="form-control" placeholder="e.g., New Town, Marina, Downtown">
                </div>
              </div>
              <div class="mt-3 d-grid">
                <button id="btnFindProperties" class="btn btn-primary btn-pill" type="button">Find Projects</button>
              </div>
              <div class="alert alert-info mt-3 mb-0 text-center" style="font-size: 13px; padding: 12px; border-radius: 8px; background: linear-gradient(135deg, #e3f2fd, #f8f9fa); border: 1px solid #bee5eb;">
                <i class="fas fa-info-circle me-2 text-info"></i>
                <strong>Note:</strong> This is an analytical and location intelligence tool.<br>
                <span class="text-muted">For details on pricing and logistics, please see country-specific advertisement sites or property websites.</span>
              </div>
              <div id="pfError" class="text-danger small mt-2 d-none"></div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card card-soft p-3">
              <div class="d-flex align-items-center justify-content-between">
                <h6 class="mb-0">AI Suggestions (Projects/Societies)</h6>
                <div class="d-flex gap-2">
                  <button id="btnPFCopyNames" class="btn btn-outline-primary btn-sm" disabled>Copy Names</button>
                  <button id="btnPFExportCSV" class="btn btn-outline-secondary btn-sm" disabled>Export CSV</button>
                  <button id="btnPFExportXLSX" class="btn btn-outline-secondary btn-sm" disabled>Export XLSX</button>
                </div>
              </div>
              <div class="form-help">Each project name is normalized to match its <b>Google Maps place name</b> when possible.</div>
              <div id="pfSummary" class="mt-3 mono prewrap text-muted">‚Äî</div>

              <div id="pfCards" class="finder-cards mt-2"></div>

              <div class="table-responsive mt-3">
                <table class="table table-sm table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>#</th><th>Project (Exact Map Name)</th><th>Area</th><th>Type</th><th>Size</th><th>Rating</th>
                    </tr>
                  </thead>
                  <tbody id="pfTableBody"><tr><td colspan="6" class="text-muted">Run a search to populate results.</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Next Steps Notice -->
        <div class="next-steps-notice">
          <strong>üìç Next Steps: Navigate to Tab 2 to analyze points of interest around selected projects, then proceed to Tab 3 for comprehensive rental yield calculations.</strong>
        </div>
      </div>

      <!-- ===== Retail (Tab 2) ===== -->
      <div class="tab-pane fade" id="panel-retail" role="tabpanel">
        <div class="row g-3">
          <div class="col-lg-7">
            <div class="card card-soft p-3">
              <div class="d-flex align-items-center justify-content-between">
                <span class="badge badge-soft px-3 py-2">Search location</span>
                <div class="d-flex gap-2">
                  <button id="btnLocate2" class="btn btn-sm btn-outline-primary btn-pill">Use My Location</button>
                </div>
              </div>
              <div class="position-relative my-2">
                <span class="position-absolute" style="left:10px;top:50%;transform:translateY(-50%);opacity:.6">üîé</span>
                <input id="searchBox2" class="form-control ps-5" placeholder="Paste a project/society name here‚Ä¶">
              </div>
              <div id="map2" class="mapbox"></div>

              <div class="row g-2 mt-2">
                <div class="col-6">
                  <label class="form-label">Search Radius: <b><span id="retailRadiusLbl">1000</span> m</b></label>
                  <input id="retailRadius" type="range" class="form-range" min="200" max="5000" value="1000" step="50">
                </div>
                <div class="col-6">
                  <label class="form-label">Max Places per Type: <b><span id="retailLimitLbl">40</span></b></label>
                  <input id="retailLimit" type="range" class="form-range" min="10" max="60" value="40" step="5">
                </div>
              </div>

              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Min Rating</label>
                  <select id="minRating" class="form-select">
                    <option value="0" selected>Any</option><option value="3.5">3.5+</option><option value="4.0">4.0+</option><option value="4.5">4.5+</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Open Now</label>
                  <select id="openNow" class="form-select">
                    <option value="any" selected>Any</option><option value="yes">Yes</option>
                  </select>
                </div>
              </div>

              <div class="text-muted small mt-2">Selected: <span id="retailLatLng">‚Äî</span></div>
            </div>
          </div>

          <div class="col-lg-5">
            <div class="card card-soft p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-1">POI Types &amp; Importance</h6>
              </div>
              <div class="text-muted small mb-1">Toggle types &amp; set importance levels for nearby facilities.</div>

              <div id="poiLegend" class="small mb-2"></div>
              <div id="poiList" class="row g-2 mt-2"></div>

              <div class="mt-3 d-grid gap-2">
                <button id="btnScanPOI" class="btn btn-primary btn-pill">Scan Area (Places)</button>
                <button id="btnScoreRetail" class="btn btn-outline-primary btn-pill" disabled>Compute Score</button>
                <div id="scoreErr" class="text-danger small mt-2 d-none"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-soft p-3 mt-3">
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Feasibility Summary</h6>
            <button id="btnResetRetail" class="btn btn-sm btn-outline-secondary btn-pill">Reset</button>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-2"><div class="stat"><div class="label">Raw Score</div><div id="retRaw" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Normalized</div><div id="retNorm" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Types Scanned</div><div id="retTypes" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Radius (m)</div><div id="retRadius" class="value">‚Äî</div></div></div>
            <div class="col-md-4"><div class="stat"><div class="label">Centers &amp; Filters</div><div id="retMeta" class="value small">‚Äî</div></div></div>
          </div>



          <pre id="retailBreakdown" class="form-control mono prewrap mt-2" style="min-height:110px;">‚Äî</pre>
        </div>

        <!-- Flat POI List -->
        <div class="card card-soft p-3 mt-3">
          <div class="d-flex flex-wrap gap-2 align-items-end">
            <div>
              <label class="form-label mb-1">Category (POI Type)</label>
              <select id="poiCategory" class="form-select form-select-sm" style="min-width:260px">
                <option value="" selected disabled>‚Äî select after scanning ‚Äî</option>
              </select>
            </div>
            <div>
              <label class="form-label mb-1">Quick Filter (text)</label>
              <input id="poiFilterText" class="form-control form-select-sm" placeholder="name/address contains...">
            </div>
            <div class="ms-auto d-flex gap-2">
              <button id="btnExportCSV" class="btn btn-outline-secondary btn-sm" type="button">Export CSV</button>
              <button id="btnExportXLSX" class="btn btn-outline-secondary btn-sm" type="button">Export XLSX</button>
            </div>
          </div>
          <div class="table-responsive mt-3">
            <table class="table table-sm table-hover" id="poiFlatTable">
              <thead class="table-light">
                <tr>
                  <th>#</th><th>Name</th><th>Address</th><th>Rating</th><th>Ratings Count</th><th>Type</th><th>Google Maps</th>
                </tr>
              </thead>
              <tbody id="poiFlatBody"><tr><td colspan="7" class="text-muted">Scan an area, choose a category, and the list will appear here.</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ===== Estimator (Tab 3) ===== -->
      <div class="tab-pane fade" id="panel-prop" role="tabpanel">
        <div class="row g-3">
          <div class="col-lg-7">
            <div class="card card-soft p-3">
              <div class="d-flex align-items-center justify-content-between">
                <span class="badge badge-soft px-3 py-2">Search location</span>
                <div class="d-flex gap-2">
                  <button id="btnLocate1" class="btn btn-sm btn-outline-primary btn-pill">Use My Location</button>
                  <button id="btnPropDemo" class="btn btn-sm btn-outline-secondary btn-pill">Demo Data</button>
                </div>
              </div>
              <div class="position-relative my-2">
                <span class="position-absolute" style="left:10px;top:50%;transform:translateY(-50%);opacity:.6">üîé</span>
                <input id="searchBox1" class="form-control ps-5" placeholder="Search address, landmark, city...">
              </div>
              <div id="map1" class="mapbox"></div>
              <div class="text-muted small mt-2">Selected: <span id="propLatLng">‚Äî</span></div>
            </div>
          </div>
          <div class="col-lg-5">
            <div class="card card-soft p-3">
              <div class="row g-2">
                <div class="col-4">
                  <label class="form-label">Currency</label>
                  <select id="currency" class="form-select">
                    <option value="INR" selected>‚Çπ INR</option><option value="AED">AED</option><option value="USD">$</option>
                  </select>
                </div>
                <div class="col-4">
                  <label class="form-label">Units</label>
                  <select id="unit" class="form-select">
                    <option value="sqft" selected>sqft</option><option value="sqm">sqm</option>
                  </select>
                </div>
                <div class="col-4">
                  <label class="form-label">Property Size</label>
                  <input id="propSize" type="number" class="form-control" placeholder="e.g., 1200">
                </div>
              </div>

              <div class="row g-2 mt-1">
                <div class="col-6">
                  <label class="form-label">Year Built (optional)</label>
                  <input id="propYear" type="number" class="form-control" placeholder="e.g., 2015">
                </div>
                <div class="col-6">
                  <label class="form-label">Condition Premium</label>
                  <input id="condPremium" type="range" min="0" max="20" step="1" class="form-range">
                  <div class="small text-muted"><span id="condPremiumLbl">0</span>%</div>
                </div>
              </div>

              <hr class="my-2">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Comparable Sales</h6>
                <button id="btnAddCompSale" class="btn btn-sm btn-outline-secondary btn-pill" type="button">+ Add Row</button>
              </div>
              <div class="text-muted small">Enter size (<span class="unit-label">sqft</span>) &amp; sale price. (Optional if you provide rents)</div>
              <table class="table table-sm mt-2" id="tblCompSales">
                <thead><tr><th>Size</th><th>Sale Price</th><th></th></tr></thead><tbody></tbody>
              </table>

              <div class="d-flex justify-content-between align-items-center mt-2">
                <h6 class="mb-0">Comparable Rents</h6>
                <button id="btnAddCompRent" class="btn btn-sm btn-outline-secondary btn-pill" type="button">+ Add Row</button>
              </div>
              <div class="text-muted small">Enter size (<span class="unit-label">sqft</span>) &amp; monthly rent. (Optional if you provide sales)</div>
              <table class="table table-sm mt-2" id="tblCompRents">
                <thead><tr><th>Size</th><th>Monthly Rent</th><th></th></tr></thead><tbody></tbody>
              </table>

              <div class="row g-2 mt-2">
                <div class="col-6">
                  <label class="form-label">Age Depreciation</label>
                  <div class="input-group input-group-sm">
                    <input id="ageDep" type="number" class="form-control" value="0.5" step="0.1"><span class="input-group-text">% / yr</span>
                  </div>
                </div>
                <div class="col-6">
                  <label class="form-label">Vacancy</label>
                  <div class="input-group input-group-sm">
                    <input id="vacancy" type="number" class="form-control" value="5" step="0.5"><span class="input-group-text">%</span>
                  </div>
                </div>
              </div>
              <div class="row g-2 mt-1">
                <div class="col-6">
                  <label class="form-label">Maintenance</label>
                  <div class="input-group input-group-sm">
                    <input id="maint" type="number" class="form-control" value="1" step="0.1"><span class="input-group-text">% of value / yr</span>
                  </div>
                </div>
                <div class="col-6">
                  <label class="form-label">Target Net Yield</label>
                  <div class="input-group input-group-sm">
                    <input id="targetYield" type="number" class="form-control" value="4" step="0.1"><span class="input-group-text">%</span>
                  </div>
                </div>
              </div>

              <div class="mt-3 d-grid gap-2">
                <button id="btnEstimate" class="btn btn-primary btn-pill" type="button">Estimate Value &amp; Yield </button>
                <button id="btnResetProp" class="btn btn-outline-secondary btn-pill" type="button">Reset</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-soft p-3 mt-3">
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Results</h6>
            <button class="btn btn-sm btn-outline-secondary btn-pill" data-copy="propResultsPre" type="button">Copy</button>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-2"><div class="stat"><div class="label">Est. Value</div><div id="propVal" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Gross Yield</div><div id="propYield" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Net Yield</div><div id="propYieldNet" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Median Sale / <span class="unit-label">sqft</span></div><div id="propPsfSale" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Median Rent / <span class="unit-label">sqft</span></div><div id="propPsfRent" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Est. Rent / mo</div><div id="propRentMo" class="value">‚Äî</div></div></div>
          </div>
          <pre id="propResultsPre" class="form-control mono prewrap mt-3" style="min-height:130px;">‚Äî</pre>
        </div>
      </div>
    </div>
  </div>

  <!-- OpenAI Modal -->
  <div class="modal fade" id="openaiModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">‚ú® Ask Atlas - Real Estate AI Assistant</h6>
          <div class="d-flex gap-2">
            <button id="btnResetChat" class="btn btn-outline-secondary btn-sm" type="button">üîÑ Reset</button>
            <button id="btnStopChat" class="btn btn-outline-danger btn-sm d-none" type="button">‚èπ Stop</button>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
        </div>
        <div class="modal-body p-0">
          <!-- Chat Messages Container -->
          <div id="chatContainer" class="p-3" style="height: 300px; overflow-y: auto; background: #f8f9fa;">
            <div class="text-center text-muted py-4">
              <div class="mb-3">üè†‚ú®</div>
              <div>Welcome to Atlas! I'm your AI real estate assistant.</div>
              <div class="small mt-2">Ask me about property analysis, market insights, or investment advice.</div>
            </div>
          </div>
          
          <!-- Chat Input Area -->
          <div class="border-top p-3">
            <div class="mb-3">
              <label class="form-label small">Quick Context</label>
              <div class="d-flex gap-2">
                <button id="btnCtxProperty" class="btn btn-outline-secondary btn-sm flex-fill" type="button">üìä Property Data</button>
                <button id="btnCtxRetail" class="btn btn-outline-secondary btn-sm flex-fill" type="button">üè™ Retail Analysis</button>
              </div>
            </div>
            
            <div class="input-group">
              <textarea id="openaiPrompt" class="form-control" rows="2" placeholder="Ask Atlas anything about real estate..." style="resize: none;"></textarea>
              <button id="btnRunOpenAI" class="btn btn-primary" type="button">
                <span class="send-text">Send</span>
                <span class="loading-text d-none">
                  <span class="spinner-border spinner-border-sm me-1"></span>
                  Thinking...
                </span>
              </button>
            </div>
            <div class="form-text small mt-1">üí° Tip: Use context buttons to add current analysis data to your message</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // =======================================================
    // Encrypted keys (no UI)
    const GMAPS_KEY_ENCRYPTED = "Qs5skmSuUzGSs5TwYxnoazaHLEgJ995LrvyyWiziwWdIzkyAfrYq";
    const OPENAI_KEY_ENCRYPTED = "cOw7g0W4eGXznpOpZzSoOFmOIm04p+lSkou0OhHs9D1LxWarB5lzePb5ss9QHLpgM5w9TQu9xmagjqUtGv/+BG3lXsJgk1oA8orawWIylTpUvw81L6jveoKPlCtUy8AmbekhmX3uIhrCkZrZExCBemLlCXNY87VUh5e/NBfo0DtM/nzHYbxQfOD5h8dKL5ZPVr03dgup2HPxj5IBC/f1BjLgIrI=";

    let GMAPS_KEY="", OPENAI_KEY="";
    let pyodide=null, pyReady=false, mapsLoaded=false;

    // ---------- Pyodide init & decrypt ----------
    (async () => {
      try{
        pyodide = await loadPyodide();
        await pyodide.runPythonAsync(`
import base64, hashlib
def decrypt_key(encrypted_data, passphrase="default_salt_2024"):
    try:
        encrypted_bytes = base64.b64decode(encrypted_data)
        key_hash = hashlib.sha256(passphrase.encode()).digest()
        out = bytearray()
        for i, b in enumerate(encrypted_bytes):
            out.append(b ^ key_hash[i % len(key_hash)])
        return out.decode('utf-8')
    except Exception:
        return ""
        `);
        pyReady = true;
        await decryptKeysAndLoad();
      }catch(e){
        console.error("Pyodide init failed", e);
        fallbackNoKeys();
      }
    })();

    async function decryptKeysAndLoad(){
      try{
        if(pyReady && pyodide){
          if (GMAPS_KEY_ENCRYPTED && !GMAPS_KEY){
            pyodide.globals.set('enc_gmaps', GMAPS_KEY_ENCRYPTED);
            GMAPS_KEY = await pyodide.runPythonAsync(`decrypt_key(enc_gmaps)`);
          }
          if (OPENAI_KEY_ENCRYPTED && !OPENAI_KEY){
            pyodide.globals.set('enc_openai', OPENAI_KEY_ENCRYPTED);
            OPENAI_KEY = await pyodide.runPythonAsync(`decrypt_key(enc_openai)`);
          }
        }
      }catch(e){ console.warn("Decryption error", e); }
      loadMapsIfKey();
    }
    function loadMapsIfKey(){
      if(mapsLoaded || !GMAPS_KEY) return;
      const s=document.createElement('script');
      s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_KEY)}&libraries=places`;
      s.async=true; s.defer=true;
      s.onload=()=>{ mapsLoaded=true; safeInitMaps(); };
      s.onerror=()=>{ console.error('Failed to load Google Maps.'); };
      document.head.appendChild(s);
    }
    function fallbackNoKeys(){ setTimeout(decryptKeysAndLoad, 1200); }

    // =======================================================
    // Finder helpers
    const pfCardsEl = ()=>document.getElementById('pfCards');
    const pfSummaryEl = ()=>document.getElementById('pfSummary');
    const pfTableBody = ()=>document.getElementById('pfTableBody');
    const pfBtnCSV = ()=>document.getElementById('btnPFExportCSV');
    const pfBtnXLSX = ()=>document.getElementById('btnPFExportXLSX');
    const pfBtnCopyNames = ()=>document.getElementById('btnPFCopyNames');
    let pfResults = [];

    function pfCurrencySymbol(c){ return ({"INR":"‚Çπ","AED":"AED ","USD":"$","SGD":"S$","GBP":"¬£"})[c] || ""; }
    function fmtMoney(n, cur){ if(n==null || isNaN(n)) return "-"; const sym = pfCurrencySymbol(cur); return sym + Math.round(Number(n)).toLocaleString(); }
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    // Build OpenAI prompt
    function pfPrompt(payload){
      return [
        { role: "system", content:
"You are a meticulous real-estate analyst.\n\
Return STRICT JSON with housing PROJECTS (societies/complexes) only.\n\
Each \"project_name\" must be the EXACT Google Maps place name if possible.\n\n\
Schema:\n\
{\n\
  \"summary\": \"1-3 bullets (city overview, price sanity, key trade-offs)\",\n\
  \"picks\": [\n\
    {\n\
      \"project_name\": \"Exact Google Maps place name\",\n\
      \"area\": \"Area/Locality\",\n\
      \"apartment_type\": \"1 BHK | 2 BHK | 3 BHK\",\n\
      \"size\": \"e.g., 1100 sqft\",\n\
      \"price\": 0,\n\
      \"price_band\": \"e.g., 65L‚Äì78L\",\n\
      \"pros\": [\"bullet\", \"bullet\"],\n\
      \"cons\": [\"bullet\"],\n\
      \"notes\": \"Short reasoning (<=25 words)\"\n\
    }\n\
  ]\n\
}" },
        { role: "user", content:
`Find ONLY ${payload.propertyType === 'commercial' ? 'COMMERCIAL office buildings, business centers, retail spaces, and commercial complexes' : 'RESIDENTIAL apartment complexes, housing societies, and residential towers'} for ${payload.type} apartments in ${payload.city}, ${payload.country}.
Property Category: ${payload.propertyType.toUpperCase()}
Country Context: ${payload.country === 'India' ? 'Indian residential market with apartment complexes and housing societies' : 'UAE residential market with modern apartment towers and residential communities'}
Preferred locality="${payload.locality || "(none)"}".
IMPORTANT: Return ONLY ${payload.propertyType === 'commercial' ? 'commercial/office properties - NO residential buildings' : `${payload.type} residential apartments in apartment complexes - NO independent houses, villas, or commercial buildings`}.
Return 8‚Äì14 diverse, realistic ${payload.propertyType === 'commercial' ? 'commercial properties with office/retail spaces' : `${payload.type} apartment projects with proper bedroom configurations`} with appropriate price ranges for ${payload.country}. Size in sqft.` }
      ];
    }

    // Heuristic fallback (16 candidates)
    function localHeuristicFinder({country, city, type, locality, propertyType}){
      // Separate area pools for residential vs commercial properties
      // Expanded area pools to ensure variety across BHK types
      const residentialAreasByCity = {
        "kolkata":["New Town","Salt Lake","Rajarhat","Tollygunge","Behala","Dum Dum","Ballygunge","Jadavpur","Ultadanga","Kasba","Baguiati","Garia","Narendrapur","EM Bypass","Lake Town","Barasat","Madhyamgram","Howrah","Serampore","Barrackpore","Bidhannagar","Action Area","Shapoorji","Webel"],
        "dubai":["Marina","JLT","JVC","Barsha","Silicon Oasis","Mirdif","Discovery Gardens","Greens","IMPZ","Sports City","Arjan","Al Furjan","Jumeirah","Bur Dubai","Karama","Satwa","Al Qusais","Muhaisnah","Al Warqa","Al Mizhar","Nad Al Sheba","Al Khawaneej","Dubailand","Motor City"],
        "singapore":["Tampines","Jurong East","Punggol","Serangoon","Bukit Timah","Toa Payoh","Kallang","Clementi","Queenstown","Woodlands","Sengkang","Yishun","Bukit Panjang","Hougang","Pasir Ris","Bedok","Ang Mo Kio","Bishan","Jurong West","Choa Chu Kang","Sembawang","Bukit Batok"]
      };
      
      const commercialAreasByCity = {
        "kolkata":["Park Street","Esplanade","BBD Bagh","Sector V","New Town","Rajarhat","EM Bypass","Camac Street","AJC Bose Road","Kasba","Jessore Road","VIP Road","Salt Lake","Bidhannagar","Action Area","Unitech","DLF","Ecospace"],
        "dubai":["Business Bay","DIFC","Downtown","Deira","Bur Dubai","Tecom","JLT","Media City","Internet City","Knowledge Village","Academic City","Dubai South","Sheikh Zayed Road","Trade Center","Karama","Al Garhoud","Festival City","Healthcare City"],
        "singapore":["CBD","Marina Bay","Orchard","Raffles Place","Tanjong Pagar","Clarke Quay","City Hall","Bugis","Novena","Jurong East","Tampines","Woodlands","Paya Lebar","One North","Changi Business Park","Seletar"]
      };
      
      const areasByCity = propertyType === 'commercial' ? commercialAreasByCity : residentialAreasByCity;
      
      const residentialSuffixes = ["Heights","Residency","Enclave","Greens","Lakeview","Garden","Vista","Court","Paradise","Orchid","Crest","Grande","Harbour","Meadows","Valley","Arcade"];
      const commercialSuffixes = ["Plaza","Tower","Complex","Center","Hub","Business Park","Corporate Center","Office Park","Trade Center","Commercial Complex","IT Park","Tech Park","Business Hub","Corporate Plaza","Office Complex","Commercial Tower"];
      
      const suffixes = propertyType === 'commercial' ? commercialSuffixes : residentialSuffixes;
      const key = (city||"").toLowerCase().trim();
      const pool = areasByCity[key] || ["Central","East","West","North","South","Midtown","Uptown","Riverside","Park","Harbour","Hill","Valley","Lake","Heights","Crescent","Arcade"];
      const picks = [];
      // Market-based pricing by city and type
      const marketPrices = {
        "kolkata": {
          // Residential
          "1 BHK": [3500000, 7500000], "2 BHK": [5500000, 12000000], "3 BHK": [8500000, 18000000],
          // Commercial  
          "Small Office": [2500000, 6000000], "Medium Office": [6000000, 15000000], "Large Office": [15000000, 40000000], "Retail Space": [4000000, 12000000]
        },
        "dubai": {
          // Residential
          "1 BHK": [800000, 1600000], "2 BHK": [1200000, 2400000], "3 BHK": [1800000, 3600000],
          // Commercial
          "Small Office": [600000, 1400000], "Medium Office": [1400000, 3500000], "Large Office": [3500000, 8000000], "Retail Space": [1000000, 2800000]
        },
        "singapore": {
          // Residential  
          "1 BHK": [850000, 1700000], "2 BHK": [1300000, 2600000], "3 BHK": [1950000, 3900000],
          // Commercial
          "Small Office": [700000, 1600000], "Medium Office": [1600000, 4000000], "Large Office": [4000000, 10000000], "Retail Space": [1200000, 3200000]
        }
      };
      const currency = key === "kolkata" ? "INR" : key === "dubai" ? "AED" : "SGD";
      const priceRange = marketPrices[key] || marketPrices["kolkata"];
      const typeRange = priceRange[type] || priceRange["2 BHK"];
      const [minPrice, maxPrice] = typeRange;
      
      for(let i=0;i<Math.min(16,pool.length);i++){
        const variation = 0.8 + (i * 0.025); // Price variation across areas
        const bandLow = Math.round(minPrice * variation);
        const bandHigh = Math.round(maxPrice * variation * 0.85);
        
        // Create unique property names based on BHK type and property type
        let pseudo;
        if (propertyType === 'commercial') {
          pseudo = pool[i] + " " + suffixes[i % suffixes.length];
        } else {
          // For residential, add BHK-specific suffixes to ensure uniqueness
          const bhkSuffixes = {
            "1 BHK": ["Nest", "Studio", "Compact", "Urban", "Smart", "Elite", "Prime", "Metro", "City", "Central", "Modern", "Cozy", "Select", "Pearl", "Gem", "Crown"],
            "2 BHK": ["Heights", "Residency", "Enclave", "Greens", "Garden", "Vista", "Court", "Paradise", "Orchid", "Grande", "Harbour", "Valley", "Arcade", "Plaza", "Tower", "Square"],
            "3 BHK": ["Luxury", "Premium", "Royal", "Grand", "Imperial", "Majestic", "Platinum", "Diamond", "Sapphire", "Golden", "Signature", "Executive", "Prestige", "Elite", "Supreme", "Pinnacle"]
          };
          const typeSuffixes = bhkSuffixes[type] || bhkSuffixes["2 BHK"];
          pseudo = pool[i] + " " + typeSuffixes[i % typeSuffixes.length];
        }
        
        // Different size calculations for residential vs commercial
        let sizeCalc;
        if (propertyType === 'commercial') {
          sizeCalc = type.includes('Small') ? `${800 + 50*i} sqft` : 
                     type.includes('Medium') ? `${2000 + 100*i} sqft` : 
                     type.includes('Large') ? `${4000 + 200*i} sqft` : 
                     `${1200 + 75*i} sqft`;
        } else {
          // BHK-specific sizes to ensure differentiation
          const baseSizes = {
            "1 BHK": 650 + (i * 25), // 650-1025 sqft range
            "2 BHK": 1050 + (i * 35), // 1050-1575 sqft range  
            "3 BHK": 1450 + (i * 45)  // 1450-2125 sqft range
          };
          sizeCalc = `${baseSizes[type] || (900 + 40*i)} sqft`;
        }
        
        // Different descriptions for residential vs commercial  
        const prosDesc = propertyType === 'commercial' ? 
          ["Prime business location", "Good corporate connectivity"] : 
          ["Good connectivity", "Reasonable social infra"];
        
        const consDesc = propertyType === 'commercial' ? 
          ["Verify parking availability", "Check lease terms"] : 
          ["Check maintenance", "Stock varies"];
        
        picks.push({
          project_name: pseudo,
          area: pool[i],
          apartment_type: type,
          size: sizeCalc,
          price: Math.round((bandLow+bandHigh)/2),
          price_band: `${fmtMoney(bandLow,currency)}‚Äì${fmtMoney(bandHigh,currency)}`,
          pros: prosDesc,
          cons: consDesc,
          notes: ""
        });
      }
      return {
        summary: `‚Ä¢ ${city}: ${type} ${propertyType === 'commercial' ? 'commercial properties' : 'apartment complexes'} across ${picks.length} different areas.\n‚Ä¢ Each project offers distinct ${propertyType === 'residential' ? type + ' configurations' : 'office layouts'} with varied amenities.\n‚Ä¢ Price ranges are market-based; verify ${propertyType === 'commercial' ? 'lease terms & facilities' : 'project status & possession dates'}.\n‚Ä¢ Prioritize ${propertyType === 'commercial' ? 'connectivity, parking & business infrastructure' : 'metro connectivity, schools & healthcare nearby'}.`,
        picks
      };
    }

    // Try to normalize each project_name to EXACT Google Maps place name via Places Text Search
    async function enrichWithPlaceMeta(picks, city){
      if(!window.google || !google.maps || !google.maps.places) return picks;
      const service = new google.maps.places.PlacesService(document.createElement('div'));

      function textSearchExact(q){
        return new Promise(resolve=>{
          service.textSearch({query:q}, (res, status)=>{
            if(status===google.maps.places.PlacesServiceStatus.OK && res && res.length){
              const r=res[0];
              resolve({
                name: r.name||"",
                rating: (typeof r.rating==='number')?r.rating:null,
                lat: r.geometry?.location?.lat?.(),
                lng: r.geometry?.location?.lng?.(),
                vicinity: r.vicinity || r.formatted_address || ""
              });
            } else resolve(null);
          });
        });
      }

      const out=[];
      for(const p of picks){
        const query = (p.project_name && p.project_name.trim())
          ? `${p.project_name}, ${city}`
          : (p.area ? `${p.area} residential complex, ${city}` : city);
        try{
          const meta = await textSearchExact(query);
          const resolvedName = meta?.name || p.project_name || "";
          out.push({...p, project_name: resolvedName, g_rating: meta?.rating ?? null, lat: meta?.lat ?? null, lng: meta?.lng ?? null, vicinity: meta?.vicinity || p.area || ""});
        }catch{
          out.push(p);
        }
      }
      return out;
    }

    // --- Locality resolver (works globally)
    async function resolveLocalityPoint(city, locality){
      if(!locality || !window.google || !google.maps?.places) return null;
      const service = new google.maps.places.PlacesService(document.createElement('div'));
      return new Promise(resolve=>{
        service.textSearch({query:`${locality}, ${city}`}, (res, status)=>{
          if(status===google.maps.places.PlacesServiceStatus.OK && res && res.length){
            const r=res[0];
            resolve({
              lat: r.geometry?.location?.lat?.(),
              lng: r.geometry?.location?.lng?.()
            });
          } else resolve(null);
        });
      });
    }

    // --- Utility distance
    function distMeters(a,b){
      if(!a||!b||typeof a.lat!=='number'||typeof a.lng!=='number'||typeof b.lat!=='number'||typeof b.lng!=='number') return Infinity;
      const R=6371000, toRad=x=>x*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const la=toRad(a.lat), lb=toRad(b.lat);
      const h=Math.sin(dLat/2)**2 + Math.cos(la)*Math.cos(lb)*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.min(1,Math.sqrt(h)));
    }

    // --- Strict filter with parameters (DEFAULT RADIUS NOW 2000 m)
    function applyFinderFilters(payload, picks, localityPoint, opts={}){
      const TYPE = (payload.type || '').trim();
      const LOC_RADIUS_M     = opts.locRadiusM    ?? 2000; // ***** 2 km default *****
      const requireGeometry  = !!opts.requireGeometry;
      const hasLocality = !!localityPoint;

      return (picks || []).filter(p=>{
        if (TYPE && p.apartment_type && p.apartment_type !== TYPE) return false;

        if (hasLocality){
          if (typeof p.lat === 'number' && typeof p.lng === 'number'){
            const d = distMeters(localityPoint, {lat: p.lat, lng: p.lng});
            if (d > LOC_RADIUS_M) return false;
          } else if (requireGeometry) {
            return false;
          }
        }
        return true;
      });
    }

    // --- Relaxation ladder: use radius steps to get adequate results
    async function relaxAndFilter(payload, picks, localityPoint){
      const TARGET = 10;
      const radiusSteps = localityPoint ? [2000, 3000, 5000] : [35000]; // Progressive radius expansion

      for (const r of radiusSteps){
        const out = applyFinderFilters(payload, picks, localityPoint, {locRadiusM:r, requireGeometry:true});
        if (out.length >= TARGET) return {out, r, strictGeo:true};
      }
      for (const r of radiusSteps){
        const out = applyFinderFilters(payload, picks, localityPoint, {locRadiusM:r, requireGeometry:false});
        if (out.length >= TARGET) return {out, r, strictGeo:false};
      }
      const fallback = applyFinderFilters(payload, picks, localityPoint, {locRadiusM:radiusSteps.at(-1), requireGeometry:false});
      return {out: fallback, r: radiusSteps.at(-1), strictGeo:false};
    }

    // --- NEW: Harvest nearby properties within 5 km if not enough results
    async function harvestNearbyProjects({ localityPoint, city, type, needCount, propertyType }){
      if(!window.google || !google.maps?.places || !localityPoint || !needCount) return [];
      const service = new google.maps.places.PlacesService(document.createElement('div'));
      const center = new google.maps.LatLng(localityPoint.lat, localityPoint.lng);

      // Helper: Nearby Search with pagination
      function nearbyWithPagination(req, cap=60){
        return new Promise(resolve=>{
          let acc=[];
          const handle = (res, status, pag)=>{
            if(status===google.maps.places.PlacesServiceStatus.OK && res && res.length){
              acc = acc.concat(res);
              if(pag && pag.hasNextPage && acc.length<cap){
                // Places API requires a small delay before calling nextPage
                setTimeout(()=>pag.nextPage(), 1200);
              } else resolve(acc);
            } else {
              resolve(acc);
            }
          };
          service.nearbySearch(req, handle);
        });
      }

      // Helper: simple Text Searches around city keywords
      function textSearchMany(queries, cap=30){
        return Promise.all(queries.map(q => new Promise(resolve=>{
          service.textSearch({query:q}, (res, status)=>{
            if(status===google.maps.places.PlacesServiceStatus.OK && res && res.length) resolve(res.slice(0,cap));
            else resolve([]);
          });
        }))).then(arrs => arrs.flat());
      }

      // We‚Äôll try nearbySearch with keywords + a few textSearch queries
      const keywords = propertyType === 'commercial' ? [
        "office building",
        "business center", 
        "commercial complex",
        "office tower",
        "business park",
        "corporate center"
      ] : [
        "apartment",
        "residential complex",
        "housing society", 
        "condominium",
        "residential tower"
      ];

      const nearbyPromises = keywords.map(kw => nearbyWithPagination({
        location: center,
        radius: 2000,
        keyword: kw
      }, 60));

      const textQueries = keywords.map(kw => `${kw} near ${city}`);
      const [nearbyResults, textResults] = await Promise.all([
        Promise.all(nearbyPromises).then(x=>x.flat()),
        textSearchMany(textQueries, 30)
      ]);

      const merge = [...nearbyResults, ...textResults];

      // Normalize, dedupe and keep within 5 km strictly
      const seen = new Set();
      const picked = [];
      for(const r of merge){
        const name = (r.name || "").trim();
        const loc = r.geometry && r.geometry.location;
        const lat = loc ? (typeof loc.lat==='function' ? loc.lat() : loc.lat) : null;
        const lng = loc ? (typeof loc.lng==='function' ? loc.lng() : loc.lng) : null;
        if(!name || typeof lat !== 'number' || typeof lng !== 'number') continue;
        const d = distMeters(localityPoint, {lat, lng});
        if(d > 2000) continue; // hard fence

        const key = name.toLowerCase();
        if(seen.has(key)) continue;
        seen.add(key);

        // Market-based price heuristic
        const marketPrices = {
          "kolkata": {"1 BHK": [3500000, 7500000], "2 BHK": [5500000, 12000000], "3 BHK": [8500000, 18000000]},
          "dubai": {"1 BHK": [800000, 1600000], "2 BHK": [1200000, 2400000], "3 BHK": [1800000, 3600000]},
          "singapore": {"1 BHK": [850000, 1700000], "2 BHK": [1300000, 2600000], "3 BHK": [1950000, 3900000]}
        };
        const cityKey = (city || "").toLowerCase().trim();
        const currency = cityKey === "kolkata" ? "INR" : cityKey === "dubai" ? "AED" : "SGD";
        const priceRange = marketPrices[cityKey] || marketPrices["kolkata"];
        const typeRange = priceRange[type] || priceRange["2 BHK"];
        const [minPrice, maxPrice] = typeRange;
        const variation = 0.9 + (Math.random() * 0.2); // Random variation ¬±10%
        const low = Math.round(minPrice * variation);
        const high = Math.round(maxPrice * variation * 0.8);
        const approxPrice = Math.round((low + high)/2);

        picked.push({
          project_name: name,
          area: r.vicinity || r.formatted_address || city || "",
          apartment_type: type,
          size: "", // unknown from Places
          price: approxPrice,
          price_band: `${fmtMoney(low, currency)}‚Äì${fmtMoney(high, currency)}`,
          pros: ["Exact Maps match","Within 2 km of chosen locality"],
          cons: ["Verify age, amenities & maintenance"],
          notes: "",
          g_rating: (typeof r.rating==='number') ? r.rating : null,
          lat, lng
        });

        if(picked.length >= needCount) break;
      }

      return picked;
    }

    function renderFinder(summary, picks, autoCurrency){
      // Auto-detect currency from the price_band format
      let currency = autoCurrency;
      if (!currency && picks && picks.length > 0) {
        const band = picks[0].price_band || "";
        if (band.includes("‚Çπ")) currency = "INR";
        else if (band.includes("AED")) currency = "AED";
        else if (band.includes("S$")) currency = "SGD";
        else if (band.includes("$")) currency = "USD";
        else if (band.includes("¬£")) currency = "GBP";
        else currency = "INR"; // fallback
      }
      pfSummaryEl().textContent = summary || "(no summary)";
      pfCardsEl().innerHTML = (picks||[]).slice(0,12).map((p,i)=>{
        const title = escapeHTML(p.project_name || `Project ${i+1}`);
        const area = escapeHTML(p.area||"-");
        const apt = escapeHTML(p.apartment_type||"-");
        const size = escapeHTML(p.size||"-");
        const notes = escapeHTML(p.notes||"");
        const gRating = (typeof p.g_rating==='number') ? `<span class="rating"><span class="star">‚òÖ</span>${p.g_rating.toFixed(1)}</span>` : '';
        return `
          <div class="prop-card">
            <div class="prop-title">${title}</div>
            <div class="text-muted small mb-1">${area} ‚Ä¢ ${apt} ‚Ä¢ ${size || '‚Äî'}</div>
            ${gRating ? `<div class="text-muted small mb-1">${gRating}</div>` : ''}
            <div class="mt-2 small text-muted">${notes}</div>
          </div>`;
      }).join("");

      if(!picks.length){
        pfTableBody().innerHTML = `<tr><td colspan="6" class="text-muted">No results returned. Try adjusting inputs.</td></tr>`;
      } else {
        pfTableBody().innerHTML = picks.map((p,i)=>{
          const title = escapeHTML(p.project_name || `Project ${i+1}`);
          const area = escapeHTML(p.area||"-");
          const apt = escapeHTML(p.apartment_type||"-");
          const size = escapeHTML(p.size||"-");
          const rating = (typeof p.g_rating==='number') ? p.g_rating.toFixed(1) : "";
          return `<tr>
            <td>${i+1}</td><td>${title}</td><td>${area}</td><td>${apt}</td><td>${size}</td><td>${rating}</td>
          </tr>`;
        }).join("");
        pfBtnCSV().disabled=false; pfBtnXLSX().disabled=false; pfBtnCopyNames().disabled=false;
      }
    }

    async function runPropertyFinder(){
      const country = document.getElementById('pfCountry').value.trim();
      const city = (document.getElementById('pfCity').value || "").trim();
      const type = document.getElementById('pfType').value;
      const locality = (document.getElementById('pfLocality').value || "").trim();
      const propertyType = document.querySelector('input[name="propertyType"]:checked').value;

      const errBox = document.getElementById('pfError');
      errBox.classList.add('d-none');
      if(!city){ errBox.textContent="Please enter a city."; errBox.classList.remove('d-none'); return; }

      const payload = { country, city, type, locality, propertyType };
      const msgs = pfPrompt(payload);

      pfSummaryEl().textContent = "Working‚Ä¶ generating project suggestions‚Ä¶";
      pfCardsEl().innerHTML = "";
      pfTableBody().innerHTML = `<tr><td colspan="6" class="text-muted">Working...</td></tr>`;
      pfBtnCSV().disabled = true; pfBtnXLSX().disabled = true; pfBtnCopyNames().disabled = true;

      let parsed = null;
      try{
        if(!OPENAI_KEY) throw new Error("OpenAI key not configured");
        const controller = new AbortController();
        const t = setTimeout(()=>controller.abort(), 7000);
        const resp = await fetch('https://api.openai.com/v1/chat/completions', {
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${OPENAI_KEY}` },
          body: JSON.stringify({
            model: "gpt-4.1",
            temperature: 0.2,
            response_format: { type: "json_object" },
            messages: msgs
          }),
          signal: controller.signal
        });
        clearTimeout(t);
        if(!resp.ok){
          const tx = await resp.text();
          throw new Error(`OpenAI error ${resp.status}: ${tx.slice(0,120)}`);
        }
        const data = await resp.json();
        const jsonText = (data?.choices?.[0]?.message?.content || "{}");
        parsed = JSON.parse(jsonText);
      }catch(e){
        console.warn("OpenAI unavailable, using local heuristic. Reason:", e.message || e);
        parsed = localHeuristicFinder(payload);
      }

      // Resolve locality coordinate (global)
      let localityPoint = null;
      try { localityPoint = await resolveLocalityPoint(city, locality); } catch {}

      const picksRaw = Array.isArray(parsed.picks) ? parsed.picks : [];
      let picks = await enrichWithPlaceMeta(picksRaw, city); // add exact map name + lat/lng when possible

      // Relax and filter to get ~10 within 5 km of locality (if provided)
      const beforeCount = picks.length;
      const relaxed = await relaxAndFilter(payload, picks, localityPoint);
      picks = relaxed.out;

      // -------- NEW: Harvest within 5 km if locality is set and we still have < TARGET --------
      const TARGET = 10;
      let harvestedCount = 0;
      if (localityPoint && picks.length < TARGET) {
        try{
          const need = TARGET - picks.length;
          const harvested = await harvestNearbyProjects({
            localityPoint,
            city,
            type,
            needCount: need,
            propertyType: payload.propertyType
          });

          // Merge-dedupe by name (case-insensitive)
          const existingNames = new Set(picks.map(p=>(p.project_name||"").toLowerCase().trim()));
          for(const h of harvested){
            const key = (h.project_name||"").toLowerCase().trim();
            if(!existingNames.has(key)){
              picks.push(h);
              existingNames.add(key);
              harvestedCount++;
              if(picks.length >= TARGET) break;
            }
          }
        }catch(err){
          console.warn("Harvest failed:", err);
        }
      }

      // Hard limit to 12 for UI (cards/table show first 12)
      pfResults = picks.slice(0, 12);

      const localityTxt = localityPoint
        ? `Locality center @ (${localityPoint.lat?.toFixed(4)}, ${localityPoint.lng?.toFixed(4)})`
        : (locality ? `Locality "${locality}" not resolved` : `No locality filter`);

      const finalSummary =
        (parsed.summary ? parsed.summary + '\n' : '') +
        `‚Ä¢ Search completed for ${payload.type} properties in ${payload.city}\n` +
        `‚Ä¢ Found ${pfResults.length} matching projects with various price ranges`;

      renderFinder(finalSummary, pfResults);
    }

    // Property type switching functionality
    function updatePropertyTypeOptions() {
      const propertyType = document.querySelector('input[name="propertyType"]:checked').value;
      const typeSelect = document.getElementById('pfType');
      const typeLabel = document.getElementById('pfTypeLabel');
      
      if (propertyType === 'commercial') {
        typeLabel.textContent = 'Space Type';
        typeSelect.innerHTML = `
          <option value="Commercial Space" selected>Commercial Space</option>
        `;
      } else {
        typeLabel.textContent = 'Apt Type';
        typeSelect.innerHTML = `
          <option value="1 BHK">1 BHK</option>
          <option value="2 BHK" selected>2 BHK</option>
          <option value="3 BHK">3 BHK</option>
        `;
      }
    }
    
    // Add event listeners for property type radio buttons
    document.querySelectorAll('input[name="propertyType"]').forEach(radio => {
      radio.addEventListener('change', updatePropertyTypeOptions);
    });
    
    // Initialize with residential options
    updatePropertyTypeOptions();
    
    document.getElementById('btnFindProperties').addEventListener('click', runPropertyFinder);
    
    // Clear functionality (can be called programmatically even without button)
    const clearPropertyFinder = () => {
      document.getElementById('pfCity').value="";
      document.getElementById('pfLocality').value="";
      document.getElementById('propTypeResidential').checked = true;
      updatePropertyTypeOptions();
      pfSummaryEl().textContent="‚Äî";
      pfCardsEl().innerHTML="";
      pfTableBody().innerHTML=`<tr><td colspan="6" class="text-muted">Run a search to populate results.</td></tr>`;
      document.getElementById('pfError').classList.add('d-none');
      pfResults = [];
      pfBtnCSV().disabled = true; pfBtnXLSX().disabled = true; pfBtnCopyNames().disabled = true;
    };

    // Copy names + exports
    document.getElementById('btnPFCopyNames').addEventListener('click', ()=>{
      if(!pfResults.length) return;
      const names = pfResults.map(p=>p.project_name || "").filter(Boolean).join("\n");
      navigator.clipboard.writeText(names).then(()=>{
        const btn = pfBtnCopyNames(); const old = btn.textContent;
        btn.textContent = "Copied!"; setTimeout(()=>btn.textContent=old, 1200);
      });
    });
    function csvCell(val){ const s = (val != null ? val : '').toString().replace(/"/g,'""'); return `"${s}"`; }
    function downloadBlob(filename, blob){
      const a = document.createElement('a'); const url = URL.createObjectURL(blob);
      a.href = url; a.download = filename; a.style.display = 'none'; document.body.appendChild(a);
      a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
    }
    document.getElementById('btnPFExportCSV').addEventListener('click', ()=>{
      if(!pfResults.length) return;
      const header = ["Project (Exact Map Name)","Area","Type","Size","Rating"];
      const rows = pfResults.map(p=>[
        p.project_name||"", p.area||"", p.apartment_type||"", p.size||"",
        (typeof p.g_rating==='number')?p.g_rating:""
      ]);
      const csv = [header.join(",")].concat(rows.map(r=>r.map(csvCell).join(","))).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      downloadBlob(`project_finder_${Date.now()}.csv`, blob);
    });
    document.getElementById('btnPFExportXLSX').addEventListener('click', ()=>{
      if(!pfResults.length) return;
      const data = [["Project (Exact Map Name)","Area","Type","Size","Rating"]]
        .concat(pfResults.map(p=>[
          p.project_name||"", p.area||"", p.apartment_type||"", p.size||"",
          (typeof p.g_rating==='number')?p.g_rating:""
        ]));
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Projects");
      const ab = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([ab], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      downloadBlob(`project_finder_${Date.now()}.xlsx`, blob);
    });

    // ======================= MAPS: PROPERTY & RETAIL =======================
    let map1=null,map2=null, marker1=null,marker2=null, circle2=null;
    let placesService1=null, placesService2=null;
    let autocomplete1=null, autocomplete2=null;
    let lastRetailScan=null, lastRetailResults=null;

    const DEFAULT_POI_TYPES = [
      {type:'hospital',label:'Hospitals',priority:'high',color:'#ef4444',emoji:'üè•'},
      {type:'pharmacy',label:'Pharmacies',priority:'high',color:'#f59e0b',emoji:'üíä'},
      {type:'doctor',label:'Clinics',priority:'high',color:'#10b981',emoji:'ü©∫'},
      {type:'ambulance',label:'Ambulances',priority:'high',color:'#dc2626',emoji:'üöë'},
      {type:'police',label:'Police Stations',priority:'high',color:'#1f2937',emoji:'üöì'},
      {type:'school',label:'Schools',priority:'medium',color:'#2563eb',emoji:'üè´'},
      {type:'university',label:'Universities',priority:'medium',color:'#7c3aed',emoji:'üéì'},
      {type:'gym',label:'Gyms',priority:'low',color:'#0ea5e9',emoji:'üèãÔ∏è'},
      {type:'restaurant',label:'Restaurants',priority:'medium',color:'#16a34a',emoji:'üçΩÔ∏è'},
      {type:'cafe',label:'Caf√©s',priority:'low',color:'#dc2626',emoji:'‚òï'},
      {type:'shopping_mall',label:'Shopping Malls',priority:'medium',color:'#ea580c',emoji:'üõçÔ∏è'},
      {type:'bank',label:'Banks',priority:'low',color:'#64748b',emoji:'üè¶'},
      {type:'transit_station',label:'Transit',priority:'high',color:'#f59e0b',emoji:'üöå'},
      {type:'subway_station',label:'Metro/Subway',priority:'high',color:'#14b8a6',emoji:'üöá'},
      {type:'supermarket',label:'Supermarkets',priority:'medium',color:'#9333ea',emoji:'üõí'},
      {type:'store',label:'Stores',priority:'low',color:'#475569',emoji:'üè™'}
    ];

    // Priority to weight mapping
    function getPriorityWeight(priority) {
      const weights = { 'high': 1.5, 'medium': 1.0, 'low': 0.5 };
      return weights[priority] || 1.0;
    }
    
    // Update POI priority and apply color coding
    function updatePOIPriority(poiType, newPriority) {
      // Find and update the POI type in our global array
      const poiIndex = DEFAULT_POI_TYPES.findIndex(poi => poi.type === poiType);
      if (poiIndex !== -1) {
        DEFAULT_POI_TYPES[poiIndex].priority = newPriority;
      }
      
      // Update color coding for this dropdown
      const dropdown = document.getElementById(`poi_priority_${poiType}`);
      if (dropdown) {
        dropdown.className = dropdown.className.replace(/priority-(high|medium|low)/g, '');
        dropdown.classList.add(`priority-${newPriority}`);
        
        // Store hidden weight for backend calculations (not shown to user)
        const weights = { 'high': 1.0, 'medium': 0.5, 'low': 0.2 };
        dropdown.dataset.weight = weights[newPriority];
      }
      
      // Recalculate scores if we have data
      if (lastRetailScan) {
        computeRetailScore();
      }
    }
    
    function safeInitMaps(){ try{ initMap1(); }catch(e){ console.warn("Map1 init error", e); } try{ initMap2(); }catch(e){ console.warn("Map2 init error", e); } }

    function initMap1(){
      if(!document.getElementById('map1')) return;
      map1=new google.maps.Map(document.getElementById('map1'),{center:{lat:22.5726,lng:88.3639},zoom:12,mapTypeControl:false});
      placesService1=new google.maps.places.PlacesService(map1);
      const input=document.getElementById('searchBox1');
      autocomplete1=new google.maps.places.Autocomplete(input,{fields:["geometry","name"]});
      autocomplete1.addListener('place_changed',()=>{
        const p=autocomplete1.getPlace(); if(!p.geometry||!p.geometry.location) return;
        const latlng={lat:p.geometry.location.lat(),lng:p.geometry.location.lng()};
        map1.setCenter(latlng); map1.setZoom(15); setMarker1(latlng);
      });
      map1.addListener('click',e=>setMarker1({lat:e.latLng.lat(),lng:e.latLng.lng()}));
      document.getElementById('btnLocate1').addEventListener('click',()=>{
        if(navigator.geolocation) navigator.geolocation.getCurrentPosition(pos=>{
          const latlng={lat:pos.coords.latitude,lng:pos.coords.longitude};
          map1.setCenter(latlng); map1.setZoom(15); setMarker1(latlng);
        },()=>alert('Location unavailable'));
      });
    }
    function setMarker1(latlng){
      if(marker1) marker1.setMap(null);
      marker1=new google.maps.Marker({position:latlng,map:map1});
      document.getElementById('propLatLng').textContent=`${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
    }

    // Estimator small helpers
    function addRow(tableId,s='',v=''){
      const tbody=document.querySelector(`#${tableId} tbody`);
      const tr=document.createElement('tr');
      if(tableId==='tblCompSales'){
        tr.innerHTML=`<td><input type="number" class="form-control form-control-sm comp-size" value="${s}"></td>
                      <td><input type="number" class="form-control form-control-sm comp-price" value="${v}"></td>
                      <td class="text-end"><button class="btn btn-sm btn-outline-danger" type="button">‚úï</button></td>`;
      }else{
        tr.innerHTML=`<td><input type="number" class="form-control form-control-sm rent-size" value="${s}"></td>
                      <td><input type="number" class="form-control form-control-sm rent-price" value="${v}"></td>
                      <td class="text-end"><button class="btn btn-sm btn-outline-danger" type="button">‚úï</button></td>`;
      }
      tbody.appendChild(tr);
      tr.querySelector('button').addEventListener('click',()=>tr.remove());
    }
    document.getElementById('btnAddCompSale').addEventListener('click',()=>addRow('tblCompSales'));
    document.getElementById('btnAddCompRent').addEventListener('click',()=>addRow('tblCompRents'));
    for(let i=0;i<3;i++){ addRow('tblCompSales'); addRow('tblCompRents'); }

    document.getElementById('btnPropDemo').addEventListener('click',()=>{
      document.querySelector('#tblCompSales tbody').innerHTML='';
      document.querySelector('#tblCompRents tbody').innerHTML='';
      const UNIT=document.getElementById('unit').value; const sz=(UNIT==='sqm')?110:1200;
      [9500000,9200000,9800000].forEach(v=>addRow('tblCompSales',sz,v));
      [28000,29500,27000].forEach(v=>addRow('tblCompRents',sz,v));
      document.getElementById('propSize').value=sz; document.getElementById('propYear').value=2017;
      document.getElementById('condPremium').value=3; document.getElementById('condPremiumLbl').textContent='3';
      document.getElementById('ageDep').value=0.5; document.getElementById('vacancy').value=5; document.getElementById('maint').value=1; document.getElementById('targetYield').value=4;
    });

    document.getElementById('btnResetProp').addEventListener('click',()=>{
      // Reset form fields
      ['propSize','propYear'].forEach(id=>document.getElementById(id).value='');
      
      // Reset sliders to default values
      document.getElementById('condPremium').value=0; 
      document.getElementById('condPremiumLbl').textContent='0';
      document.getElementById('ageDep').value=0.5; 
      document.getElementById('vacancy').value=5; 
      document.getElementById('maint').value=1; 
      document.getElementById('targetYield').value=4;
      
      // Clear tables and add default rows
      document.querySelector('#tblCompSales tbody').innerHTML=''; 
      document.querySelector('#tblCompRents tbody').innerHTML='';
      for(let i=0;i<3;i++){ addRow('tblCompSales'); addRow('tblCompRents'); }
      
      // Clear results
      ['propVal','propYield','propYieldNet','propPsfSale','propPsfRent','propRentMo'].forEach(id=>document.getElementById(id).textContent='‚Äî');
      document.getElementById('propResultsPre').textContent='‚Äî';
      
      // Clear map marker
      if(marker1) { marker1.setMap(null); marker1 = null; }
      
      // Reset map to default center and zoom
      if(map1) {
        map1.setCenter({lat:22.5726,lng:88.3639});
        map1.setZoom(12);
      }
      
      // Clear search box
      const searchBox = document.getElementById('searchBox1');
      if(searchBox) searchBox.value = '';
    });

    document.getElementById('condPremium').addEventListener('input', e=>{
      document.getElementById('condPremiumLbl').textContent = e.target.value;
    });

    function fmtMoneyEstimator(n){
      const cur = {"INR":"‚Çπ","AED":"AED ","USD":"$"}[document.getElementById('currency').value]||"";
      return (n==null||isNaN(n)) ? '-' : (cur + Math.round(n).toLocaleString());
    }
    function fmtPct(n){ return (n==null||isNaN(n)) ? '-' : (n.toFixed(2)+' %'); }

    document.getElementById('btnEstimate').addEventListener('click',async ()=>{
      try{
        if(!pyReady){ alert('Python engine is still loading. Please try again.'); return; }
        const SQ_CONV = { sqft:1, sqm:10.7639 };
        const UNIT = document.getElementById('unit').value;
        const u2 = SQ_CONV[UNIT]||1;
        const size = parseFloat(document.getElementById('propSize').value||'0') * u2;
        if(!(size>0)){ alert('Enter a valid property size.'); return; }
        const yearStr=document.getElementById('propYear').value.trim();
        const year=yearStr?parseInt(yearStr):null;
        let lat=null,lng=null; if(marker1){ lat=marker1.getPosition().lat(); lng=marker1.getPosition().lng(); }
        const sales=[], rents=[];
        document.querySelectorAll('#tblCompSales tbody tr').forEach(tr=>{
          const s=parseFloat(tr.querySelector('.comp-size').value||'0')*u2; const p=parseFloat(tr.querySelector('.comp-price').value||'0'); if(s>0&&p>0) sales.push({size:s,price:p});
        });
        document.querySelectorAll('#tblCompRents tbody tr').forEach(tr=>{
          const s=parseFloat(tr.querySelector('.rent-size').value||'0')*u2; const r=parseFloat(tr.querySelector('.rent-price').value||'0'); if(s>0&&r>0) rents.push({size:s,rent:r});
        });

        // Convert JavaScript arrays to Python-compatible format and set in globals
        pyodide.globals.set('prop_size_sqft', size);
        pyodide.globals.set('comp_sales_json', JSON.stringify(sales));
        pyodide.globals.set('comp_rents_json', JSON.stringify(rents));
        pyodide.globals.set('prop_lat', lat);
        pyodide.globals.set('prop_lng', lng);
        pyodide.globals.set('prop_year', year);
        pyodide.globals.set('cond_premium', parseFloat(document.getElementById('condPremium').value||'0'));
        pyodide.globals.set('age_depreciation', parseFloat(document.getElementById('ageDep').value||'0'));
        pyodide.globals.set('vacancy_rate', parseFloat(document.getElementById('vacancy').value||'0'));
        pyodide.globals.set('maintenance_rate', parseFloat(document.getElementById('maint').value||'0'));
        pyodide.globals.set('target_yield', parseFloat(document.getElementById('targetYield').value||'0'));

        const code = `
import math, statistics, json, datetime

def _to_num(x, default=0.0):
    try: return float(x)
    except: return float(default)

def _coerce_rows(lst, kind):
    out=[]
    for it in (lst or []):
        d=dict(it)
        if kind=='sale':
            size=_to_num(d.get('size',0)); price=_to_num(d.get('price',0))
            if size>0 and price>0: out.append({'size':size,'price':price})
        else:
            size=_to_num(d.get('size',0)); rent=_to_num(d.get('rent',0))
            if size>0 and rent>0: out.append({'size':size,'rent':rent})
    return out

def estimate_property(size_sqft, comp_sales, comp_rents, lat=None, lng=None, year_built=None, cond_premium_pct=0.0, age_dep_pct_per_year=0.0, vac_pct=0.0, maint_pct=0.0, target_yield_pct=0.0, fallback_cap_rate=0.06):
    size_sqft=_to_num(size_sqft,0)
    comp_sales=_coerce_rows(comp_sales,'sale'); comp_rents=_coerce_rows(comp_rents,'rent')
    if not comp_sales and not comp_rents:
        raise ValueError("Need at least one sale or one rent comparable.")
    psf=[r['price']/r['size'] for r in comp_sales if r['size']>0 and r['price']>0]
    rpsf=[r['rent']/r['size'] for r in comp_rents if r['size']>0 and r['rent']>0]
    med_psf=statistics.median(psf) if psf else None
    prem=max(0.0, cond_premium_pct/100.0)
    dep_mult=1.0
    if year_built:
        try:
            y=int(year_built); yrs=max(0, datetime.datetime.now().year - y)
            dep_mult=max(0.6, 1.0 - (age_dep_pct_per_year/100.0)*yrs)
        except: pass
    est_val=None
    if med_psf is not None:
        est_val=med_psf*size_sqft*dep_mult*(1.0+prem)
    med_rpsf=None; est_rent_mo=None; gross=None; net=None
    if rpsf:
        med_rpsf=statistics.median(rpsf)
        est_rent_mo=med_rpsf*size_sqft
        if est_rent_mo and est_rent_mo>0:
            annual=est_rent_mo*12.0
            if est_val:
                gross = (annual / est_val) * 100.0
                vac_amt = (vac_pct/100.0)*annual
                maint_amt = (maint_pct/100.0)*est_val
                net = ((annual - vac_amt - maint_amt) / est_val) * 100.0
            else:
                ty = max(0.0, target_yield_pct/100.0)
                if ty > 0:
                    net_income = annual * (1.0 - vac_pct/100.0)
                    est_val = net_income / ty
                else:
                    est_val = annual / max(1e-6, float(fallback_cap_rate))
    return json.dumps({
        "median_sale_psf": med_psf,
        "median_rent_psf": med_rpsf,
        "estimated_value": est_val,
        "estimated_rent_month": est_rent_mo,
        "gross_yield_pct": gross,
        "net_yield_pct": net,
        "lat": lat, "lng": lng,
        "size_sqft": size_sqft,
        "year_built": year_built,
        "dep_mult": dep_mult,
        "premium_pct": prem*100.0
    })

# Parse JSON strings to Python objects
comp_sales = json.loads(comp_sales_json) if comp_sales_json else []
comp_rents = json.loads(comp_rents_json) if comp_rents_json else []

# Get data from JavaScript globals and run estimation
result = estimate_property(
    prop_size_sqft, 
    comp_sales, 
    comp_rents, 
    prop_lat, 
    prop_lng, 
    prop_year, 
    cond_premium, 
    age_depreciation, 
    vacancy_rate, 
    maintenance_rate, 
    target_yield
)
result
`;
        const out = await pyodide.runPythonAsync(code);
        const obj=JSON.parse(out);

        document.getElementById('propVal').textContent=fmtMoneyEstimator(obj.estimated_value);
        document.getElementById('propYield').textContent=fmtPct(obj.gross_yield_pct);
        document.getElementById('propYieldNet').textContent=fmtPct(obj.net_yield_pct);
        document.getElementById('propPsfSale').textContent=obj.median_sale_psf?fmtMoneyEstimator(obj.median_sale_psf):'‚Äî';
        document.getElementById('propPsfRent').textContent=obj.median_rent_psf?fmtMoneyEstimator(obj.median_rent_psf):'‚Äî';
        document.getElementById('propRentMo').textContent=fmtMoneyEstimator(obj.estimated_rent_month);

        const lines=[];
        lines.push(`Location: ${obj.lat&&obj.lng?obj.lat.toFixed(6)+', '+obj.lng.toFixed(6):'not set'}`);
        lines.push(`Size: ${document.getElementById('propSize').value} ${getUnitValue()} ‚Ä¢ Year: ${obj.year_built||'-'}`);
        lines.push(`Depreciation x${obj.dep_mult.toFixed(3)} ‚Ä¢ Condition +${obj.premium_pct.toFixed(1)}%`);
        lines.push(`Estimated Value: ${fmtMoneyEstimator(obj.estimated_value)}`);
        lines.push(`Gross Yield: ${fmtPct(obj.gross_yield_pct)} ‚Ä¢ Net Yield: ${fmtPct(obj.net_yield_pct)}`);
        document.getElementById('propResultsPre').textContent=lines.join('\n');
      }catch(err){
        console.error(err);
        alert('Estimation failed: ' + (err && err.message ? err.message : 'See console'));
      }
    });

    const UNIT_LAB_INIT = ()=>document.querySelectorAll('.unit-label').forEach(e=>e.textContent=document.getElementById('unit').value);
    function getUnitValue(){ return document.getElementById('unit').value; }
    UNIT_LAB_INIT();

    // Map 2 (Retail)
    const markersByType={};
    function initMap2(){
      if(!document.getElementById('map2')) return;
      map2=new google.maps.Map(document.getElementById('map2'),{center:{lat:22.5726,lng:88.3639},zoom:12,mapTypeControl:false});
      placesService2=new google.maps.places.PlacesService(map2);
      const input=document.getElementById('searchBox2');
      autocomplete2=new google.maps.places.Autocomplete(input,{fields:["geometry","name"]});
      autocomplete2.addListener('place_changed',()=>{
        const p=autocomplete2.getPlace(); if(!p.geometry||!p.geometry.location) return;
        const latlng={lat:p.geometry.location.lat(),lng:p.geometry.location.lng()};
        map2.setCenter(latlng); map2.setZoom(15); setMarker2(latlng);
      });
      map2.addListener('click',e=>setMarker2({lat:e.latLng.lat(),lng:e.latLng.lng()}));
      document.getElementById('retailRadius').addEventListener('input',e=>{document.getElementById('retailRadiusLbl').textContent=e.target.value; if(marker2) drawCircle2();});
      document.getElementById('retailLimit').addEventListener('input',e=>document.getElementById('retailLimitLbl').textContent=e.target.value);
      buildPOIControls();
      document.getElementById('btnLocate2').addEventListener('click',()=>{
        if(navigator.geolocation) navigator.geolocation.getCurrentPosition(pos=>{
          const latlng={lat:pos.coords.latitude,lng:pos.coords.longitude};
          map2.setCenter(latlng); map2.setZoom(15); setMarker2(latlng);
        },()=>alert('Location unavailable'));
      });
    }
    function setMarker2(latlng){
      if(marker2) marker2.setMap(null);
      marker2=new google.maps.Marker({position:latlng,map:map2});
      drawCircle2(); document.getElementById('retailLatLng').textContent=`${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
    }
    function drawCircle2(){
      const radius=parseInt(document.getElementById('retailRadius').value||'1000');
      const latlng=marker2.getPosition(); if(circle2) circle2.setMap(null);
      circle2=new google.maps.Circle({map:map2,center:latlng,radius:radius,fillOpacity:.05,strokeColor:'#2563eb'});
    }
    function clearMarkers(){ Object.values(markersByType).forEach(arr=>arr.forEach(m=>m.setMap(null))); Object.keys(markersByType).forEach(k=>markersByType[k]=[]); }
    function buildPOIControls(){
      const list=document.getElementById('poiList'); list.innerHTML='';
      const legend=document.getElementById('poiLegend'); legend.innerHTML='<span class="me-2">Legend:</span>';
      DEFAULT_POI_TYPES.forEach(t=>{
        const div=document.createElement('div'); div.className='col-12';
        div.innerHTML=`
          <div class="poi-control-row">
            <div class="poi-left-section">
              <span class="poi-legend-dot" style="background:${t.color}"></span>
              <div class="poi-switch">
                <input class="form-check-input" type="checkbox" id="poi_ck_${t.type}" checked>
                <label class="form-check-label" for="poi_ck_${t.type}">${t.emoji} ${t.label}</label>
              </div>
            </div>
            <div class="priority-section">
              <div class="priority-label">Importance:</div>
              <select id="poi_priority_${t.type}" class="priority-select priority-${t.priority}" onchange="updatePOIPriority('${t.type}', this.value)">
                <option value="high" ${t.priority === 'high' ? 'selected' : ''}>üî¥ High</option>
                <option value="medium" ${t.priority === 'medium' ? 'selected' : ''}>üü° Medium</option>
                <option value="low" ${t.priority === 'low' ? 'selected' : ''}>üü¢ Low</option>
              </select>
            </div>
          </div>`;
        list.appendChild(div);
        const lg=document.createElement('span'); 
        lg.style.cssText = 'display: inline-flex; align-items: center; gap: 6px; margin-right: 16px; font-size: 13px; font-weight: 500;';
        lg.innerHTML=`<span class="poi-legend-dot" style="background:${t.color}"></span>${t.emoji} ${t.label}`;
        legend.appendChild(lg);
      });
    }

    function makeEmojiMarkerOptions(t, position){
      return { position, map:map2,
        icon:{ path:google.maps.SymbolPath.CIRCLE, scale:7, fillColor:t.color, fillOpacity:1, strokeColor:'#333', strokeWeight:0.5 },
        label:{ text:t.emoji, fontSize:'12px' }, title:t.label };
    }
    async function nearbySearchAllTypes(center, radius, limit){
      const openNowSel=document.getElementById('openNow').value;
      const openNow=openNowSel==='yes'?true:undefined;
      const selected=DEFAULT_POI_TYPES.filter(t=>document.getElementById('poi_ck_'+t.type).checked);
      const resultsByType={}; clearMarkers();
      for(const t of selected){
        resultsByType[t.type]=await new Promise(resolve=>{
          let out=[]; const req={location:center, radius:radius, type:t.type, openNow};
          placesService2.nearbySearch(req,(res,status,pag)=>{
            if(status===google.maps.places.PlacesServiceStatus.OK && res){
              out=out.concat(res);
              if(pag && pag.hasNextPage && out.length<limit){ setTimeout(()=>pag.nextPage(),250); }
              else resolve(out.slice(0,limit));
            } else resolve(out);
          });
        });
        markersByType[t.type]=[];
        (resultsByType[t.type]||[]).forEach(p=>{
          if(!p.geometry||!p.geometry.location) return;
          const meta = DEFAULT_POI_TYPES.find(x=>x.type===t.type) || {color:'#2563eb',emoji:'‚Ä¢',label:t.label};
          const m=new google.maps.Marker(makeEmojiMarkerOptions(meta,p.geometry.location));
          markersByType[t.type].push(m);
        });
      }
      return resultsByType;
    }

    document.getElementById('btnScanPOI').addEventListener('click', async ()=>{
      if(!marker2){ alert('Pick a center on the map (or paste a project name).'); return; }
      const center=marker2.getPosition();
      const radius=parseInt(document.getElementById('retailRadius').value||'1000');
      const limit=parseInt(document.getElementById('retailLimit').value||'40');
      const minRating=parseFloat(document.getElementById('minRating').value||'0');
      const centerLatLng={lat:center.lat(), lng:center.lng()};
      const results=await nearbySearchAllTypes(centerLatLng, radius, limit);
      lastRetailResults = results;
      const filtered = {}; Object.keys(results).forEach(t=>{ filtered[t]=(results[t]||[]).filter(x=>(x.rating||0)>=minRating); });
      const counts={}, ratings={};
      Object.keys(filtered).forEach(t=>{
        const arr=filtered[t]||[]; counts[t]=arr.length;
        ratings[t]=arr.length ? (arr.reduce((s,x)=>s+(x.rating||0),0)/arr.length) : 0;
      });
      lastRetailScan={center:centerLatLng, radius, counts, ratings, minRating, openNow:document.getElementById('openNow').value};
      document.getElementById('retTypes').textContent=Object.keys(results).length.toString();
      document.getElementById('retRadius').textContent=radius.toString();
      document.getElementById('retMeta').textContent=`Rating>=${minRating||'any'}; Open:${lastRetailScan.openNow}`;
      document.getElementById('retailBreakdown').textContent=
        `Scanned ${Object.keys(results).length} types within ${radius}m.\nCounts: ${JSON.stringify(counts)}\nAvg ratings: ${JSON.stringify(ratings)}\nClick "Compute Score".`;
      document.getElementById('scoreErr').classList.add('d-none');
      document.getElementById('btnScoreRetail').disabled = false;
      const sel = document.getElementById('poiCategory');
      sel.innerHTML = `<option value="" selected disabled>‚Äî choose a category ‚Äî</option>`;
      Object.keys(lastRetailResults||{}).forEach(k=>{
        const meta = DEFAULT_POI_TYPES.find(z=>z.type===k);
        const lbl = meta ? `${meta.emoji} ${meta.label}` : k;
        sel.insertAdjacentHTML('beforeend', `<option value="${k}">${lbl} (${counts[k]||0})</option>`);
      });
      renderPOIFlatList();
    });

    document.getElementById('btnScoreRetail').addEventListener('click', async ()=>{
      try{
        if(!pyReady){ alert('Python engine is still loading. Please try again.'); return; }
        if(!lastRetailScan){ alert('Run "Scan Area" first.'); return; }
        const weights = {};
        DEFAULT_POI_TYPES.forEach(t => {
          const ckEl = document.getElementById('poi_ck_' + t.type);
          const priority = DEFAULT_POI_TYPES.find(poi => poi.type === t.type)?.priority || 'medium';
          const priorityWeight = getPriorityWeight(priority);
          weights[t.type] = (ckEl && ckEl.checked) ? priorityWeight : 0;
        });
        const cts = {}, rts = {};
        Object.keys(weights).forEach(k=>{
          const c = parseFloat((lastRetailScan.counts && lastRetailScan.counts[k]) || 0);
          const r = parseFloat((lastRetailScan.ratings && lastRetailScan.ratings[k]) || 0);
          cts[k] = isFinite(c) ? c : 0;
          rts[k] = isFinite(r) ? r : 0;
        });
        const payload = { counts: cts, ratings: rts, weights, radius_m: Number(lastRetailScan.radius) || 1 };
        pyodide.globals.set('score_payload', JSON.stringify(payload));
        const result = await pyodide.runPythonAsync(`
import json, math
def score_retail(counts_by_type, avg_rating_by_type, weights, radius_m):
    keys=set(list((counts_by_type or {}).keys())+list((weights or {}).keys())+list((avg_rating_by_type or {}).keys()))
    score=0.0; detail={}
    for t in keys:
        c=float(counts_by_type.get(t,0) or 0); w=float(weights.get(t,0) or 0); r=float(avg_rating_by_type.get(t,0) or 0)
        rb=max(0.0,(r-3.0)*0.5); part=w*(c+rb); detail[t]={"count":c,"weight":w,"avg_rating":r,"component":part}; score+=part
    norm=score/max(1.0, math.log(max(10.0, float(radius_m or 1))))
    return {"raw_score":score,"normalized_score":norm,"detail":detail}

p = json.loads(score_payload)
result = score_retail(p["counts"], p["ratings"], p["weights"], p["radius_m"])
json.dumps(result)
        `);
        const obj = JSON.parse(result);
        document.getElementById('retRaw').textContent = (+obj.raw_score).toFixed(2);
        document.getElementById('retNorm').textContent = (+obj.normalized_score).toFixed(3);
        // Calculate score breakdown by priority
        let scoreBreakdown = '';
        let totalScore = 0;
        const priorityTotals = { high: 0, medium: 0, low: 0 };
        
        DEFAULT_POI_TYPES.forEach(t => {
          const ckEl = document.getElementById('poi_ck_' + t.type);
          if (ckEl && ckEl.checked && lastRetailScan.counts && lastRetailScan.counts[t.type]) {
            const count = lastRetailScan.counts[t.type] || 0;
            const priority = t.priority;
            const weight = getPriorityWeight(priority);
            const contribution = count * weight;
            totalScore += contribution;
            priorityTotals[priority] += contribution;
            
            const priorityIcon = priority === 'high' ? 'üî¥' : priority === 'medium' ? 'üü°' : 'üü¢';
            const priorityText = priority === 'high' ? 'High Importance' : priority === 'medium' ? 'Medium Importance' : 'Low Importance';
            scoreBreakdown += `${t.emoji} ${t.label}: ${count > 0 ? `${count} facilities available nearby` : 'Limited availability in area'} (${priorityIcon} ${priorityText})\n`;
          }
        });
        
        const lines = [];
        lines.push(`üìç Center: ${lastRetailScan.center.lat.toFixed(6)}, ${lastRetailScan.center.lng.toFixed(6)}`);
        lines.push(`üìè Radius: ${lastRetailScan.radius} m`);
        lines.push(`üîç Filters: rating>=${lastRetailScan.minRating||'any'}; open=${lastRetailScan.openNow}`);
        lines.push(``);
        const ratingText = totalScore >= 15 ? 'Excellent' : totalScore >= 10 ? 'Very Good' : totalScore >= 5 ? 'Good' : 'Average';
        lines.push(`üè¢ LOCATION CONVENIENCE SUMMARY:`);
        lines.push(``);
        lines.push(`üî¥ High Importance Facilities: ${Math.round(priorityTotals.high)} options nearby`);
        lines.push(`üü° Medium Importance Facilities: ${Math.round(priorityTotals.medium)} options nearby`);
        lines.push(`üü¢ Low Importance Facilities: ${Math.round(priorityTotals.low)} options nearby`);
        lines.push(``);
        lines.push(`üè¢ AVAILABLE NEARBY AMENITIES:`);
        lines.push(scoreBreakdown);
        document.getElementById('retailBreakdown').textContent = lines.join('\n');
        document.getElementById('scoreErr').classList.add('d-none');
      }catch(err){
        console.error('Compute Score error:', err);
        const box = document.getElementById('scoreErr');
        if(box){ box.textContent = (err && err.message) ? err.message : 'Scoring failed.'; box.classList.remove('d-none'); }
        else { alert('Scoring failed. See console for details.'); }
      }
    });

    // Tab 2 Reset Button
    document.getElementById('btnResetRetail').addEventListener('click', ()=>{
      // Clear map marker and POI markers
      if(marker2) { marker2.setMap(null); marker2 = null; }
      if(circle2) { circle2.setMap(null); circle2 = null; }
      clearMarkers(); // Clear all POI markers
      
      // Reset map to default center and zoom
      if(map2) {
        map2.setCenter({lat:22.5726,lng:88.3639});
        map2.setZoom(12);
      }
      
      // Clear search box
      const searchBox2 = document.getElementById('searchBox2');
      if(searchBox2) searchBox2.value = '';
      
      // Reset form controls to defaults
      document.getElementById('retailRadius').value = 1000;
      document.getElementById('retailRadiusLbl').textContent = '1000';
      document.getElementById('retailLimit').value = 50;
      document.getElementById('retailLimitLbl').textContent = '50';
      document.getElementById('minRating').value = 0;
      document.getElementById('openNow').value = 'any';
      
      // Reset POI category and filter
      document.getElementById('poiCategory').value = 'all';
      document.getElementById('poiFilterText').value = '';
      
      // Clear results
      ['retRaw', 'retNorm', 'retTypes', 'retRadius', 'retMeta'].forEach(id => 
        document.getElementById(id).textContent = '‚Äî'
      );
      
      // Clear breakdown table and text
      const tbody = document.getElementById('retTableBody');
      if(tbody) tbody.innerHTML = '';
      document.getElementById('retailBreakdown').textContent = '‚Äî';
      
      // Clear location display
      document.getElementById('retailLatLng').textContent = '‚Äî';
      
      // Disable compute score button
      document.getElementById('btnScoreRetail').disabled = true;
      
      // Clear stored scan data
      lastRetailScan = null;
      
      // Reset POI controls to defaults (rebuild them)
      buildPOIControls();
      
      // Clear flat POI list
      renderPOIFlatList();
    });

    const poiSel = document.getElementById('poiCategory');
    const poiFilter = document.getElementById('poiFilterText');
    ['change','input'].forEach(ev=>{
      document.getElementById('minRating').addEventListener(ev, renderPOIFlatList);
      document.getElementById('openNow').addEventListener(ev, renderPOIFlatList);
    });
    if(poiSel) poiSel.addEventListener('change', ()=> renderPOIFlatList());
    if(poiFilter) poiFilter.addEventListener('input', ()=> renderPOIFlatList());

    function normalizeResultItem(type, p, idx){
      let lat=null, lng=null;
      if (p && p.geometry && p.geometry.location) {
        const loc = p.geometry.location;
        lat = (typeof loc.lat === 'function') ? loc.lat() : loc.lat;
        lng = (typeof loc.lng === 'function') ? loc.lng() : loc.lng;
      }
      let queryLink = '';
      if (typeof lat === 'number' && typeof lng === 'number') {
        const latStr = lat.toFixed(7);
        const lngStr = lng.toFixed(7);
        queryLink = `https://www.google.com/maps/dir/?api=1&destination=${latStr},${lngStr}`;
      }
      return {
        idx: idx+1,
        name: p.name || '',
        address: p.vicinity || p.formatted_address || '',
        rating: typeof p.rating==='number' ? p.rating : '',
        ratingCount: p.user_ratings_total || '',
        isOpen: !!(p.opening_hours && p.opening_hours.open_now),
        type,
        link: queryLink
      };
    }
    function currentPOISelection(){
      if(!lastRetailResults) return [];
      const cat = poiSel.value;
      const arr = (cat && lastRetailResults[cat]) ? lastRetailResults[cat] : [];
      const minR = parseFloat(document.getElementById('minRating').value || '0');
      const openSel = document.getElementById('openNow').value;
      const ftxt = (poiFilter.value||'').toLowerCase();
      const rows = arr.map((p,i)=>normalizeResultItem(cat,p,i)).filter(r=>{
        const passRating = (r.rating === '' ? (minR <= 0) : Number(r.rating) >= minR);
        const passOpen = (openSel === 'any') ? true : r.isOpen === true;
        const hay = `${r.name} ${r.address}`.toLowerCase();
        const passQuick = ftxt ? hay.includes(ftxt) : true;
        return passRating && passOpen && passQuick;
      });
      return rows;
    }
    function renderPOIFlatList(){
      const body = document.getElementById('poiFlatBody');
      const rows = currentPOISelection();
      if(!rows.length){
        body.innerHTML = `<tr><td colspan="7" class="text-muted">No items ‚Äî select a category after scanning, or adjust your filters.</td></tr>`;
        return;
      }
      body.innerHTML = rows.map(r=>{
        const poiType = DEFAULT_POI_TYPES.find(p => p.type === r.type);
        const priority = poiType?.priority || 'medium';
        return `<tr>
          <td>${r.idx}</td><td>${escapeHTML(r.name)}</td><td>${escapeHTML(r.address)}</td>
          <td>${r.rating!==''?Number(r.rating).toFixed(1):''}</td><td>${r.ratingCount}</td>
          <td>${r.type}</td>
          <td>${r.link ? `<a href="${r.link}" target="_blank" rel="noopener">Open</a>` : ''}</td>
        </tr>`;
      }).join('');
    }

    // Export functionality for POI list in second tab
    document.getElementById('btnExportCSV').addEventListener('click', ()=>{
      const rows = currentPOISelection();
      if(!rows.length) {
        alert('No POI data to export. Please scan an area first and select a category.');
        return;
      }
      const header = ["#","Name","Address","Rating","Ratings Count","Type","Google Maps"];
      const csvRows = rows.map(r=>{
        return [
          r.idx, r.name, r.address, 
          r.rating !== '' ? Number(r.rating).toFixed(1) : '',
          r.ratingCount || '',
          r.type || '',
          r.link || ''
        ];
      });
      const csv = [header.join(",")].concat(csvRows.map(r=>r.map(csvCell).join(","))).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      downloadBlob(`poi_export_${Date.now()}.csv`, blob);
    });

    document.getElementById('btnExportXLSX').addEventListener('click', ()=>{
      const rows = currentPOISelection();
      if(!rows.length) {
        alert('No POI data to export. Please scan an area first and select a category.');
        return;
      }
      const data = [["#","Name","Address","Rating","Ratings Count","Type","Google Maps"]]
        .concat(rows.map(r=>{
          return [
            r.idx, r.name, r.address,
            r.rating !== '' ? Number(r.rating).toFixed(1) : '',
            r.ratingCount || '',
            r.type || '',
            r.link || ''
          ];
        }));
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "POI_Data");
      const ab = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([ab], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      downloadBlob(`poi_export_${Date.now()}.xlsx`, blob);
    });

    // ---------- OpenAI Modal ----------
    const openaiModal = new bootstrap.Modal(document.getElementById('openaiModal'));
    // Chat System Variables
    let chatMessages = [];
    let currentAbortController = null;

    // Chat System Functions
    function addChatMessage(role, content, isTyping = false) {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${role}`;
      
      const avatar = document.createElement('div');
      avatar.className = `chat-avatar ${role}`;
      avatar.textContent = role === 'user' ? 'üë§' : 'üè†';
      
      const bubble = document.createElement('div');
      bubble.className = `chat-bubble ${role}${isTyping ? ' typing' : ''}`;
      bubble.textContent = content;
      
      if (role === 'user') {
        messageDiv.appendChild(bubble);
        messageDiv.appendChild(avatar);
      } else {
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
      }
      
      // Remove welcome message if it exists
      const welcomeMsg = chatContainer.querySelector('.text-center');
      if (welcomeMsg) welcomeMsg.remove();
      
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      return bubble;
    }

    function clearChat() {
      const chatContainer = document.getElementById('chatContainer');
      chatContainer.innerHTML = `
        <div class="text-center text-muted py-4">
          <div class="mb-3">üè†‚ú®</div>
          <div>Welcome to Atlas! I'm your AI real estate assistant.</div>
          <div class="small mt-2">Ask me about property analysis, market insights, or investment advice.</div>
        </div>
      `;
      chatMessages = [];
    }

    function toggleChatUI(isGenerating) {
      const sendBtn = document.getElementById('btnRunOpenAI');
      const stopBtn = document.getElementById('btnStopChat');
      const promptInput = document.getElementById('openaiPrompt');
      
      if (isGenerating) {
        sendBtn.querySelector('.send-text').classList.add('d-none');
        sendBtn.querySelector('.loading-text').classList.remove('d-none');
        sendBtn.disabled = true;
        stopBtn.classList.remove('d-none');
        promptInput.disabled = true;
      } else {
        sendBtn.querySelector('.send-text').classList.remove('d-none');
        sendBtn.querySelector('.loading-text').classList.add('d-none');
        sendBtn.disabled = false;
        stopBtn.classList.add('d-none');
        promptInput.disabled = false;
      }
    }

    async function streamChatResponse(messages, model) {
      const key = OPENAI_KEY;
      if (!key) throw new Error("OpenAI key not configured");
      
      currentAbortController = new AbortController();
      
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${key}`
        },
        body: JSON.stringify({
          model,
          messages,
          temperature: 0.2,
          stream: true
        }),
        signal: currentAbortController.signal
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(`OpenAI error ${response.status}: ${text.slice(0, 180)}`);
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let assistantBubble = addChatMessage('assistant', 'Thinking...', true);
      let fullResponse = '';

      try {
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') continue;

              try {
                const parsed = JSON.parse(data);
                const content = parsed.choices?.[0]?.delta?.content;
                if (content) {
                  fullResponse += content;
                  assistantBubble.className = assistantBubble.className.replace(' typing', '');
                  assistantBubble.textContent = fullResponse;
                  document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
                }
              } catch (e) {
                // Ignore parsing errors for incomplete chunks
              }
            }
          }
        }
      } finally {
        reader.releaseLock();
      }

      return fullResponse;
    }

    // Event Handlers
    document.getElementById('btnOpenAIModal').addEventListener('click', () => openaiModal.show());
    
    document.getElementById('btnResetChat').addEventListener('click', () => {
      clearChat();
    });

    document.getElementById('btnStopChat').addEventListener('click', () => {
      if (currentAbortController) {
        currentAbortController.abort();
        currentAbortController = null;
      }
      toggleChatUI(false);
    });

    document.getElementById('btnCtxProperty').addEventListener('click', () => {
      const loc = document.getElementById('propLatLng').textContent || '‚Äî';
      const size = document.getElementById('propSize').value || '‚Äî';
      const unit = document.getElementById('unit').value;
      const val = document.getElementById('propVal').textContent || '‚Äî';
      const gy = document.getElementById('propYield').textContent || '‚Äî';
      const ny = document.getElementById('propYieldNet').textContent || '‚Äî';
      const ctx = `PROPERTY CONTEXT:
- Location: ${loc}
- Size: ${size} ${unit}
- Estimated Value: ${val}
- Gross Yield: ${gy}
- Net Yield: ${ny}

Please analyze this property's investment attractiveness, risk factors, and negotiation pointers.`;
      const ta = document.getElementById('openaiPrompt');
      ta.value = (ta.value ? ta.value + "\n\n" : "") + ctx;
      ta.focus();
    });

    document.getElementById('btnCtxRetail').addEventListener('click', () => {
      const c = lastRetailScan;
      const ctx = c ? `RETAIL CONTEXT:
- Center: ${c.center.lat.toFixed(6)}, ${c.center.lng.toFixed(6)}
- Radius: ${c.radius} m
- Filters: rating>=${c.minRating||'any'}; open=${c.openNow}
- Counts by type: ${JSON.stringify(c.counts)}
- Average ratings by type: ${JSON.stringify(c.ratings)}

Please summarize trade area strengths/weaknesses and suggest 3 retail categories likely to perform well.` : `RETAIL CONTEXT: (no scan yet)`;
      const ta = document.getElementById('openaiPrompt');
      ta.value = (ta.value ? ta.value + "\n\n" : "") + ctx;
      ta.focus();
    });

    document.getElementById('btnRunOpenAI').addEventListener('click', async () => {
      const prompt = document.getElementById('openaiPrompt').value.trim();
      if (!prompt) {
        alert('Please enter a message first.');
        return;
      }

      const model = 'gpt-4.1'; // Always use GPT-4.1 Advanced
      
      // Add user message to chat
      addChatMessage('user', prompt);
      chatMessages.push({ role: 'user', content: prompt });
      
      // Clear input
      document.getElementById('openaiPrompt').value = '';
      
      toggleChatUI(true);

      try {
        const response = await streamChatResponse([
          { role: 'system', content: 'You are Atlas, an expert real estate AI assistant. Provide helpful, accurate advice about property investment, market analysis, and real estate trends. Be concise but thorough in your responses.' },
          ...chatMessages
        ], model);
        
        chatMessages.push({ role: 'assistant', content: response });
      } catch (err) {
        console.error('Chat error:', err);
        if (err.name !== 'AbortError') {
          addChatMessage('assistant', `‚ùå Error: ${err.message}\n\n(If CORS blocks browser calls, you may need a proxy API.)`);
        }
      } finally {
        toggleChatUI(false);
        currentAbortController = null;
      }
    });

    // Allow Enter to send message (Shift+Enter for new line)
    document.getElementById('openaiPrompt').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('btnRunOpenAI').click();
      }
    });

    // Tab map reflow
    document.querySelectorAll('#mainTabs button[data-bs-toggle="tab"]').forEach(btn=>{
      btn.addEventListener('shown.bs.tab', e=>{
        if(window.google){
          if(e.target.id==='tab-prop'){
            if(!map1) {
              initMap1();
            } else {
              const c=map1.getCenter(); 
              google.maps.event.trigger(map1,'resize'); 
              map1.setCenter(c);
            }
          }
          if(e.target.id==='tab-retail' && map2){ const c=map2.getCenter(); google.maps.event.trigger(map2,'resize'); map2.setCenter(c); }
        }
      });
    });
  </script>
</body>
</html>